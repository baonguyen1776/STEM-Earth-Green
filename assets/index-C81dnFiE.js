import{W as _t,P as mt,A as W,S as k,a as ft,C as l,F as B,b as gt,D as X,c as yt,V as p,M as L,T as S,Q as $,d as q,e as y,R as vt,f as bt,g as wt,h as Mt,i as I,j as st,k as xt,l as Ct,m as Y,N as ot,n as St,o as V,p as nt,B as Lt,G as at,q as rt,r as T,s as lt,t as ht,O as Dt,E as Pt,u as Et,v as Tt,I as Q,w as kt}from"./three-DJ0EU59u.js";import{g as Rt}from"./gsap-DDlvirwQ.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=e(s);fetch(s.href,n)}})();const x={antialias:!0,alpha:!0,powerPreference:"high-performance",maxPixelRatio:2,clearColor:0,clearAlpha:1};class At{_renderer;_container;_resizeObserver=null;_resizeHandler=null;_isDisposed=!1;constructor(t={}){this._container=this.resolveContainer(t.container);const e=this.resolveCanvas(t.canvas);this._renderer=new _t({canvas:e,antialias:t.antialias??x.antialias,alpha:t.alpha??x.alpha,powerPreference:t.powerPreference??x.powerPreference}),this.configure(t),this.setupResizeHandling(),this.updateSize()}get webGLRenderer(){return this._renderer}get domElement(){return this._renderer.domElement}get container(){return this._container}get size(){return{width:this._container.clientWidth,height:this._container.clientHeight}}get aspectRatio(){const{width:t,height:e}=this.size;return e>0?t/e:1}get isDisposed(){return this._isDisposed}render(t,e){if(this._isDisposed){console.warn("Renderer: Attempting to render after disposal");return}this._renderer.render(t,e)}updateSize(){if(this._isDisposed)return;const{width:t,height:e}=this.size;this._renderer.setSize(t,e,!1),window.dispatchEvent(new CustomEvent("renderer:resize",{detail:{width:t,height:e,aspectRatio:this.aspectRatio}}))}setPixelRatio(t){const e=x.maxPixelRatio,i=window.devicePixelRatio??1,s=t??Math.min(i,e);this._renderer.setPixelRatio(s)}setClearColor(t,e=1){this._renderer.setClearColor(t,e)}setShadows(t,e=mt){this._renderer.shadowMap.enabled=t,this._renderer.shadowMap.type=e}setToneMapping(t=W,e=1){this._renderer.toneMapping=t,this._renderer.toneMappingExposure=e}getInfo(){return this._renderer.info}clear(t=!0,e=!0,i=!0){this._renderer.clear(t,e,i)}dispose(){this._isDisposed||(this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),this._resizeHandler&&(window.removeEventListener("resize",this._resizeHandler),this._resizeHandler=null),this._renderer.dispose(),this._renderer.domElement.parentNode&&this._renderer.domElement.parentNode.removeChild(this._renderer.domElement),this._isDisposed=!0)}resolveContainer(t){if(!t)return document.body;if(typeof t=="string"){const e=document.querySelector(t);if(!e)throw new Error(`Renderer: Container not found: ${t}`);return e}return t}resolveCanvas(t){if(t){if(typeof t=="string"){const e=document.querySelector(t);if(!e)throw new Error(`Renderer: Canvas not found: ${t}`);return e}return t}}configure(t){const e=x.maxPixelRatio,i=t.pixelRatio??Math.min(window.devicePixelRatio,e);this._renderer.setPixelRatio(i),this._renderer.outputColorSpace=k,this._renderer.toneMapping=W,this._renderer.toneMappingExposure=1;const s=x.clearColor,n=x.clearAlpha;this._renderer.setClearColor(s,n),this._renderer.domElement.parentNode||this._container.appendChild(this._renderer.domElement),this._renderer.domElement.style.display="block"}setupResizeHandling(){typeof ResizeObserver<"u"&&(this._resizeObserver=new ResizeObserver(()=>{this.updateSize()}),this._resizeObserver.observe(this._container)),this._resizeHandler=()=>{this.updateSize()},window.addEventListener("resize",this._resizeHandler)}}const It={clean:"#4a9eff",polluted:"#3d3228"},Ot={clean:"#1e90ff",polluted:"#4a4a4a",smog:"#2d2418",clouds:"#f0f0f0"},zt={smoke:"#808080",smokeDense:"#1a1a1a",plasticTrash:"#ff6b6b",metalTrash:"#a8a8a8"},Nt={accent:"#1e90ff",success:"#4caf50",warning:"#ff9800",error:"#f44336"},Ht={ambient:"#ffffff"},m={earth:It,atmosphere:Ot,effects:zt,ui:Nt,lights:Ht},Ft={ambientIntensity:.6,ambientColor:m.lights.ambient,directionalIntensity:3.5,directionalColor:16777215,directionalPosition:{x:5,y:3,z:10},backLightIntensity:.8,backLightColor:6719692,backLightPosition:{x:-8,y:-3,z:-8}};class jt{_scene;_ambientLight;_directionalLight;_backLight;_objects=new Map;_isDisposed=!1;constructor(t={}){this._scene=new ft,t.backgroundColor!==void 0&&(this._scene.background=new l(t.backgroundColor)),t.fog&&(this._scene.fog=new B(t.fog.color,t.fog.near,t.fog.far));const e={...Ft,...t.lights};this._ambientLight=new gt(e.ambientColor,e.ambientIntensity),this._scene.add(this._ambientLight),this._directionalLight=new X(e.directionalColor,e.directionalIntensity),this._directionalLight.position.set(e.directionalPosition.x,e.directionalPosition.y,e.directionalPosition.z),this._scene.add(this._directionalLight),this._backLight=new X(e.backLightColor,e.backLightIntensity),this._backLight.position.set(e.backLightPosition.x,e.backLightPosition.y,e.backLightPosition.z),this._scene.add(this._backLight)}get scene(){return this._scene}get ambientLight(){return this._ambientLight}get directionalLight(){return this._directionalLight}get backLight(){return this._backLight}get objects(){return new Map(this._objects)}get isDisposed(){return this._isDisposed}add(t,e){return this._isDisposed?(console.warn("SceneManager: Cannot add object after disposal"),t):(this._scene.add(t),e&&this._objects.set(e,t),t)}remove(t){if(this._isDisposed)return!1;let e;if(typeof t=="string")e=this._objects.get(t),e&&this._objects.delete(t);else{e=t;for(const[i,s]of this._objects)if(s===e){this._objects.delete(i);break}}return e?(this._scene.remove(e),!0):!1}get(t){return this._objects.get(t)}has(t){return this._objects.has(t)}clearObjects(){for(const[,t]of this._objects)this._scene.remove(t);this._objects.clear()}setAmbientIntensity(t){this._ambientLight.intensity=t}setDirectionalIntensity(t){this._directionalLight.intensity=t}setBackLightIntensity(t){this._backLight.intensity=t}setLightIntensities(t,e,i){this._ambientLight.intensity=t,this._directionalLight.intensity=e,this._backLight.intensity=i}setDirectionalLightPosition(t,e,i){this._directionalLight.position.set(t,e,i)}setBackground(t){t===null?this._scene.background=null:this._scene.background=new l(t)}setFog(t,e,i){this._scene.fog=new B(t,e,i)}clearFog(){this._scene.fog=null}traverse(t){this._scene.traverse(t)}find(t){let e;return this._scene.traverse(i=>{!e&&t(i)&&(e=i)}),e}dispose(){if(!this._isDisposed){for(const[,t]of this._objects)this.disposeObject(t);this._objects.clear(),this._ambientLight.dispose(),this._directionalLight.dispose(),this._backLight.dispose(),this._scene.clear(),this._isDisposed=!0}}disposeObject(t){if("geometry"in t&&t.geometry&&t.geometry.dispose(),"material"in t&&t.material){const e=Array.isArray(t.material)?t.material:[t.material];for(const i of e)i&&typeof i.dispose=="function"&&i.dispose()}for(const e of t.children)this.disposeObject(e)}}const J={type:"change"},G={type:"start"},ct={type:"end"},A=new vt,tt=new bt,Ut=Math.cos(70*wt.DEG2RAD),u=new p,g=2*Math.PI,h={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6},H=1e-6;class Yt extends yt{constructor(t,e=null){super(t,e),this.state=h.NONE,this.target=new p,this.cursor=new p,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.keyRotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:L.ROTATE,MIDDLE:L.DOLLY,RIGHT:L.PAN},this.touches={ONE:S.ROTATE,TWO:S.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this._lastPosition=new p,this._lastQuaternion=new $,this._lastTargetPosition=new p,this._quat=new $().setFromUnitVectors(t.up,new p(0,1,0)),this._quatInverse=this._quat.clone().invert(),this._spherical=new q,this._sphericalDelta=new q,this._scale=1,this._panOffset=new p,this._rotateStart=new y,this._rotateEnd=new y,this._rotateDelta=new y,this._panStart=new y,this._panEnd=new y,this._panDelta=new y,this._dollyStart=new y,this._dollyEnd=new y,this._dollyDelta=new y,this._dollyDirection=new p,this._mouse=new y,this._performCursorZoom=!1,this._pointers=[],this._pointerPositions={},this._controlActive=!1,this._onPointerMove=Gt.bind(this),this._onPointerDown=Vt.bind(this),this._onPointerUp=Zt.bind(this),this._onContextMenu=Qt.bind(this),this._onMouseWheel=Bt.bind(this),this._onKeyDown=Xt.bind(this),this._onTouchStart=$t.bind(this),this._onTouchMove=qt.bind(this),this._onMouseDown=Kt.bind(this),this._onMouseMove=Wt.bind(this),this._interceptControlDown=Jt.bind(this),this._interceptControlUp=te.bind(this),this.domElement!==null&&this.connect(this.domElement),this.update()}connect(t){super.connect(t),this.domElement.addEventListener("pointerdown",this._onPointerDown),this.domElement.addEventListener("pointercancel",this._onPointerUp),this.domElement.addEventListener("contextmenu",this._onContextMenu),this.domElement.addEventListener("wheel",this._onMouseWheel,{passive:!1}),this.domElement.getRootNode().addEventListener("keydown",this._interceptControlDown,{passive:!0,capture:!0}),this.domElement.style.touchAction="none"}disconnect(){this.domElement.removeEventListener("pointerdown",this._onPointerDown),this.domElement.ownerDocument.removeEventListener("pointermove",this._onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this._onPointerUp),this.domElement.removeEventListener("pointercancel",this._onPointerUp),this.domElement.removeEventListener("wheel",this._onMouseWheel),this.domElement.removeEventListener("contextmenu",this._onContextMenu),this.stopListenToKeyEvents(),this.domElement.getRootNode().removeEventListener("keydown",this._interceptControlDown,{capture:!0}),this.domElement.style.touchAction="auto"}dispose(){this.disconnect()}getPolarAngle(){return this._spherical.phi}getAzimuthalAngle(){return this._spherical.theta}getDistance(){return this.object.position.distanceTo(this.target)}listenToKeyEvents(t){t.addEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=t}stopListenToKeyEvents(){this._domElementKeyEvents!==null&&(this._domElementKeyEvents.removeEventListener("keydown",this._onKeyDown),this._domElementKeyEvents=null)}saveState(){this.target0.copy(this.target),this.position0.copy(this.object.position),this.zoom0=this.object.zoom}reset(){this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(J),this.update(),this.state=h.NONE}update(t=null){const e=this.object.position;u.copy(e).sub(this.target),u.applyQuaternion(this._quat),this._spherical.setFromVector3(u),this.autoRotate&&this.state===h.NONE&&this._rotateLeft(this._getAutoRotationAngle(t)),this.enableDamping?(this._spherical.theta+=this._sphericalDelta.theta*this.dampingFactor,this._spherical.phi+=this._sphericalDelta.phi*this.dampingFactor):(this._spherical.theta+=this._sphericalDelta.theta,this._spherical.phi+=this._sphericalDelta.phi);let i=this.minAzimuthAngle,s=this.maxAzimuthAngle;isFinite(i)&&isFinite(s)&&(i<-Math.PI?i+=g:i>Math.PI&&(i-=g),s<-Math.PI?s+=g:s>Math.PI&&(s-=g),i<=s?this._spherical.theta=Math.max(i,Math.min(s,this._spherical.theta)):this._spherical.theta=this._spherical.theta>(i+s)/2?Math.max(i,this._spherical.theta):Math.min(s,this._spherical.theta)),this._spherical.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,this._spherical.phi)),this._spherical.makeSafe(),this.enableDamping===!0?this.target.addScaledVector(this._panOffset,this.dampingFactor):this.target.add(this._panOffset),this.target.sub(this.cursor),this.target.clampLength(this.minTargetRadius,this.maxTargetRadius),this.target.add(this.cursor);let n=!1;if(this.zoomToCursor&&this._performCursorZoom||this.object.isOrthographicCamera)this._spherical.radius=this._clampDistance(this._spherical.radius);else{const a=this._spherical.radius;this._spherical.radius=this._clampDistance(this._spherical.radius*this._scale),n=a!=this._spherical.radius}if(u.setFromSpherical(this._spherical),u.applyQuaternion(this._quatInverse),e.copy(this.target).add(u),this.object.lookAt(this.target),this.enableDamping===!0?(this._sphericalDelta.theta*=1-this.dampingFactor,this._sphericalDelta.phi*=1-this.dampingFactor,this._panOffset.multiplyScalar(1-this.dampingFactor)):(this._sphericalDelta.set(0,0,0),this._panOffset.set(0,0,0)),this.zoomToCursor&&this._performCursorZoom){let a=null;if(this.object.isPerspectiveCamera){const r=u.length();a=this._clampDistance(r*this._scale);const d=r-a;this.object.position.addScaledVector(this._dollyDirection,d),this.object.updateMatrixWorld(),n=!!d}else if(this.object.isOrthographicCamera){const r=new p(this._mouse.x,this._mouse.y,0);r.unproject(this.object);const d=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),this.object.updateProjectionMatrix(),n=d!==this.object.zoom;const w=new p(this._mouse.x,this._mouse.y,0);w.unproject(this.object),this.object.position.sub(w).add(r),this.object.updateMatrixWorld(),a=u.length()}else console.warn("WARNING: OrbitControls.js encountered an unknown camera type - zoom to cursor disabled."),this.zoomToCursor=!1;a!==null&&(this.screenSpacePanning?this.target.set(0,0,-1).transformDirection(this.object.matrix).multiplyScalar(a).add(this.object.position):(A.origin.copy(this.object.position),A.direction.set(0,0,-1).transformDirection(this.object.matrix),Math.abs(this.object.up.dot(A.direction))<Ut?this.object.lookAt(this.target):(tt.setFromNormalAndCoplanarPoint(this.object.up,this.target),A.intersectPlane(tt,this.target))))}else if(this.object.isOrthographicCamera){const a=this.object.zoom;this.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/this._scale)),a!==this.object.zoom&&(this.object.updateProjectionMatrix(),n=!0)}return this._scale=1,this._performCursorZoom=!1,n||this._lastPosition.distanceToSquared(this.object.position)>H||8*(1-this._lastQuaternion.dot(this.object.quaternion))>H||this._lastTargetPosition.distanceToSquared(this.target)>H?(this.dispatchEvent(J),this._lastPosition.copy(this.object.position),this._lastQuaternion.copy(this.object.quaternion),this._lastTargetPosition.copy(this.target),!0):!1}_getAutoRotationAngle(t){return t!==null?g/60*this.autoRotateSpeed*t:g/60/60*this.autoRotateSpeed}_getZoomScale(t){const e=Math.abs(t*.01);return Math.pow(.95,this.zoomSpeed*e)}_rotateLeft(t){this._sphericalDelta.theta-=t}_rotateUp(t){this._sphericalDelta.phi-=t}_panLeft(t,e){u.setFromMatrixColumn(e,0),u.multiplyScalar(-t),this._panOffset.add(u)}_panUp(t,e){this.screenSpacePanning===!0?u.setFromMatrixColumn(e,1):(u.setFromMatrixColumn(e,0),u.crossVectors(this.object.up,u)),u.multiplyScalar(t),this._panOffset.add(u)}_pan(t,e){const i=this.domElement;if(this.object.isPerspectiveCamera){const s=this.object.position;u.copy(s).sub(this.target);let n=u.length();n*=Math.tan(this.object.fov/2*Math.PI/180),this._panLeft(2*t*n/i.clientHeight,this.object.matrix),this._panUp(2*e*n/i.clientHeight,this.object.matrix)}else this.object.isOrthographicCamera?(this._panLeft(t*(this.object.right-this.object.left)/this.object.zoom/i.clientWidth,this.object.matrix),this._panUp(e*(this.object.top-this.object.bottom)/this.object.zoom/i.clientHeight,this.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),this.enablePan=!1)}_dollyOut(t){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale/=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_dollyIn(t){this.object.isPerspectiveCamera||this.object.isOrthographicCamera?this._scale*=t:(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),this.enableZoom=!1)}_updateZoomParameters(t,e){if(!this.zoomToCursor)return;this._performCursorZoom=!0;const i=this.domElement.getBoundingClientRect(),s=t-i.left,n=e-i.top,a=i.width,r=i.height;this._mouse.x=s/a*2-1,this._mouse.y=-(n/r)*2+1,this._dollyDirection.set(this._mouse.x,this._mouse.y,1).unproject(this.object).sub(this.object.position).normalize()}_clampDistance(t){return Math.max(this.minDistance,Math.min(this.maxDistance,t))}_handleMouseDownRotate(t){this._rotateStart.set(t.clientX,t.clientY)}_handleMouseDownDolly(t){this._updateZoomParameters(t.clientX,t.clientX),this._dollyStart.set(t.clientX,t.clientY)}_handleMouseDownPan(t){this._panStart.set(t.clientX,t.clientY)}_handleMouseMoveRotate(t){this._rotateEnd.set(t.clientX,t.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const e=this.domElement;this._rotateLeft(g*this._rotateDelta.x/e.clientHeight),this._rotateUp(g*this._rotateDelta.y/e.clientHeight),this._rotateStart.copy(this._rotateEnd),this.update()}_handleMouseMoveDolly(t){this._dollyEnd.set(t.clientX,t.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),this._dollyDelta.y>0?this._dollyOut(this._getZoomScale(this._dollyDelta.y)):this._dollyDelta.y<0&&this._dollyIn(this._getZoomScale(this._dollyDelta.y)),this._dollyStart.copy(this._dollyEnd),this.update()}_handleMouseMovePan(t){this._panEnd.set(t.clientX,t.clientY),this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd),this.update()}_handleMouseWheel(t){this._updateZoomParameters(t.clientX,t.clientY),t.deltaY<0?this._dollyIn(this._getZoomScale(t.deltaY)):t.deltaY>0&&this._dollyOut(this._getZoomScale(t.deltaY)),this.update()}_handleKeyDown(t){let e=!1;switch(t.code){case this.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?this.enableRotate&&this._rotateUp(g*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,this.keyPanSpeed),e=!0;break;case this.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?this.enableRotate&&this._rotateUp(-g*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(0,-this.keyPanSpeed),e=!0;break;case this.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?this.enableRotate&&this._rotateLeft(g*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(this.keyPanSpeed,0),e=!0;break;case this.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?this.enableRotate&&this._rotateLeft(-g*this.keyRotateSpeed/this.domElement.clientHeight):this.enablePan&&this._pan(-this.keyPanSpeed,0),e=!0;break}e&&(t.preventDefault(),this.update())}_handleTouchStartRotate(t){if(this._pointers.length===1)this._rotateStart.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),i=.5*(t.pageX+e.x),s=.5*(t.pageY+e.y);this._rotateStart.set(i,s)}}_handleTouchStartPan(t){if(this._pointers.length===1)this._panStart.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),i=.5*(t.pageX+e.x),s=.5*(t.pageY+e.y);this._panStart.set(i,s)}}_handleTouchStartDolly(t){const e=this._getSecondPointerPosition(t),i=t.pageX-e.x,s=t.pageY-e.y,n=Math.sqrt(i*i+s*s);this._dollyStart.set(0,n)}_handleTouchStartDollyPan(t){this.enableZoom&&this._handleTouchStartDolly(t),this.enablePan&&this._handleTouchStartPan(t)}_handleTouchStartDollyRotate(t){this.enableZoom&&this._handleTouchStartDolly(t),this.enableRotate&&this._handleTouchStartRotate(t)}_handleTouchMoveRotate(t){if(this._pointers.length==1)this._rotateEnd.set(t.pageX,t.pageY);else{const i=this._getSecondPointerPosition(t),s=.5*(t.pageX+i.x),n=.5*(t.pageY+i.y);this._rotateEnd.set(s,n)}this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart).multiplyScalar(this.rotateSpeed);const e=this.domElement;this._rotateLeft(g*this._rotateDelta.x/e.clientHeight),this._rotateUp(g*this._rotateDelta.y/e.clientHeight),this._rotateStart.copy(this._rotateEnd)}_handleTouchMovePan(t){if(this._pointers.length===1)this._panEnd.set(t.pageX,t.pageY);else{const e=this._getSecondPointerPosition(t),i=.5*(t.pageX+e.x),s=.5*(t.pageY+e.y);this._panEnd.set(i,s)}this._panDelta.subVectors(this._panEnd,this._panStart).multiplyScalar(this.panSpeed),this._pan(this._panDelta.x,this._panDelta.y),this._panStart.copy(this._panEnd)}_handleTouchMoveDolly(t){const e=this._getSecondPointerPosition(t),i=t.pageX-e.x,s=t.pageY-e.y,n=Math.sqrt(i*i+s*s);this._dollyEnd.set(0,n),this._dollyDelta.set(0,Math.pow(this._dollyEnd.y/this._dollyStart.y,this.zoomSpeed)),this._dollyOut(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);const a=(t.pageX+e.x)*.5,r=(t.pageY+e.y)*.5;this._updateZoomParameters(a,r)}_handleTouchMoveDollyPan(t){this.enableZoom&&this._handleTouchMoveDolly(t),this.enablePan&&this._handleTouchMovePan(t)}_handleTouchMoveDollyRotate(t){this.enableZoom&&this._handleTouchMoveDolly(t),this.enableRotate&&this._handleTouchMoveRotate(t)}_addPointer(t){this._pointers.push(t.pointerId)}_removePointer(t){delete this._pointerPositions[t.pointerId];for(let e=0;e<this._pointers.length;e++)if(this._pointers[e]==t.pointerId){this._pointers.splice(e,1);return}}_isTrackingPointer(t){for(let e=0;e<this._pointers.length;e++)if(this._pointers[e]==t.pointerId)return!0;return!1}_trackPointer(t){let e=this._pointerPositions[t.pointerId];e===void 0&&(e=new y,this._pointerPositions[t.pointerId]=e),e.set(t.pageX,t.pageY)}_getSecondPointerPosition(t){const e=t.pointerId===this._pointers[0]?this._pointers[1]:this._pointers[0];return this._pointerPositions[e]}_customWheelEvent(t){const e=t.deltaMode,i={clientX:t.clientX,clientY:t.clientY,deltaY:t.deltaY};switch(e){case 1:i.deltaY*=16;break;case 2:i.deltaY*=100;break}return t.ctrlKey&&!this._controlActive&&(i.deltaY*=10),i}}function Vt(o){this.enabled!==!1&&(this._pointers.length===0&&(this.domElement.setPointerCapture(o.pointerId),this.domElement.ownerDocument.addEventListener("pointermove",this._onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this._onPointerUp)),!this._isTrackingPointer(o)&&(this._addPointer(o),o.pointerType==="touch"?this._onTouchStart(o):this._onMouseDown(o)))}function Gt(o){this.enabled!==!1&&(o.pointerType==="touch"?this._onTouchMove(o):this._onMouseMove(o))}function Zt(o){switch(this._removePointer(o),this._pointers.length){case 0:this.domElement.releasePointerCapture(o.pointerId),this.domElement.ownerDocument.removeEventListener("pointermove",this._onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this._onPointerUp),this.dispatchEvent(ct),this.state=h.NONE;break;case 1:const t=this._pointers[0],e=this._pointerPositions[t];this._onTouchStart({pointerId:t,pageX:e.x,pageY:e.y});break}}function Kt(o){let t;switch(o.button){case 0:t=this.mouseButtons.LEFT;break;case 1:t=this.mouseButtons.MIDDLE;break;case 2:t=this.mouseButtons.RIGHT;break;default:t=-1}switch(t){case L.DOLLY:if(this.enableZoom===!1)return;this._handleMouseDownDolly(o),this.state=h.DOLLY;break;case L.ROTATE:if(o.ctrlKey||o.metaKey||o.shiftKey){if(this.enablePan===!1)return;this._handleMouseDownPan(o),this.state=h.PAN}else{if(this.enableRotate===!1)return;this._handleMouseDownRotate(o),this.state=h.ROTATE}break;case L.PAN:if(o.ctrlKey||o.metaKey||o.shiftKey){if(this.enableRotate===!1)return;this._handleMouseDownRotate(o),this.state=h.ROTATE}else{if(this.enablePan===!1)return;this._handleMouseDownPan(o),this.state=h.PAN}break;default:this.state=h.NONE}this.state!==h.NONE&&this.dispatchEvent(G)}function Wt(o){switch(this.state){case h.ROTATE:if(this.enableRotate===!1)return;this._handleMouseMoveRotate(o);break;case h.DOLLY:if(this.enableZoom===!1)return;this._handleMouseMoveDolly(o);break;case h.PAN:if(this.enablePan===!1)return;this._handleMouseMovePan(o);break}}function Bt(o){this.enabled===!1||this.enableZoom===!1||this.state!==h.NONE||(o.preventDefault(),this.dispatchEvent(G),this._handleMouseWheel(this._customWheelEvent(o)),this.dispatchEvent(ct))}function Xt(o){this.enabled!==!1&&this._handleKeyDown(o)}function $t(o){switch(this._trackPointer(o),this._pointers.length){case 1:switch(this.touches.ONE){case S.ROTATE:if(this.enableRotate===!1)return;this._handleTouchStartRotate(o),this.state=h.TOUCH_ROTATE;break;case S.PAN:if(this.enablePan===!1)return;this._handleTouchStartPan(o),this.state=h.TOUCH_PAN;break;default:this.state=h.NONE}break;case 2:switch(this.touches.TWO){case S.DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchStartDollyPan(o),this.state=h.TOUCH_DOLLY_PAN;break;case S.DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchStartDollyRotate(o),this.state=h.TOUCH_DOLLY_ROTATE;break;default:this.state=h.NONE}break;default:this.state=h.NONE}this.state!==h.NONE&&this.dispatchEvent(G)}function qt(o){switch(this._trackPointer(o),this.state){case h.TOUCH_ROTATE:if(this.enableRotate===!1)return;this._handleTouchMoveRotate(o),this.update();break;case h.TOUCH_PAN:if(this.enablePan===!1)return;this._handleTouchMovePan(o),this.update();break;case h.TOUCH_DOLLY_PAN:if(this.enableZoom===!1&&this.enablePan===!1)return;this._handleTouchMoveDollyPan(o),this.update();break;case h.TOUCH_DOLLY_ROTATE:if(this.enableZoom===!1&&this.enableRotate===!1)return;this._handleTouchMoveDollyRotate(o),this.update();break;default:this.state=h.NONE}}function Qt(o){this.enabled!==!1&&o.preventDefault()}function Jt(o){o.key==="Control"&&(this._controlActive=!0,this.domElement.getRootNode().addEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}function te(o){o.key==="Control"&&(this._controlActive=!1,this.domElement.getRootNode().removeEventListener("keyup",this._interceptControlUp,{passive:!0,capture:!0}))}const F={fov:75,near:.1,far:1e3},j={x:0,y:0,z:15},ee={x:0,y:0,z:50},v={enableDamping:!0,dampingFactor:.05,enableZoom:!0,minDistance:8,maxDistance:30,enableRotate:!0,enablePan:!1,autoRotate:!1,autoRotateSpeed:2,minPolarAngle:0,maxPolarAngle:Math.PI},ie={introDuration:3};class se{_camera;_controls=null;_resizeHandler=null;_isDisposed=!1;constructor(t={}){const e=t.fov??F.fov,i=t.near??F.near,s=t.far??F.far,n=window.innerWidth/window.innerHeight;this._camera=new Mt(e,n,i,s);const a=t.position??j;this._camera.position.set(a.x,a.y,a.z);const r=t.lookAt??{x:0,y:0,z:0};this._camera.lookAt(r.x,r.y,r.z),t.enableControls!==!1&&t.domElement&&this.setupControls(t.domElement),this.setupResizeHandling()}get camera(){return this._camera}get controls(){return this._controls}get position(){return this._camera.position.clone()}get rotation(){return this._camera.rotation.clone()}get isDisposed(){return this._isDisposed}setPosition(t,e,i){this._camera.position.set(t,e,i),this._controls?.update()}setTarget(t,e,i){this._controls?(this._controls.target.set(t,e,i),this._controls.update()):this._camera.lookAt(t,e,i)}getTarget(){if(this._controls)return this._controls.target.clone();const t=new p;return this._camera.getWorldDirection(t),this._camera.position.clone().add(t.multiplyScalar(10))}setFOV(t){this._camera.fov=t,this._camera.updateProjectionMatrix()}setAspect(t){this._camera.aspect=t,this._camera.updateProjectionMatrix()}updateAspect(t,e){e!==void 0?this._camera.aspect=t/e:this._camera.aspect=t,this._camera.updateProjectionMatrix()}enableControls(){this._controls&&(this._controls.enabled=!0)}disableControls(){this._controls&&(this._controls.enabled=!1)}setControlsEnabled(t){this._controls&&(this._controls.enabled=t)}setAutoRotate(t,e=2){this._controls&&(this._controls.autoRotate=t,this._controls.autoRotateSpeed=e)}setZoomLimits(t,e){this._controls&&(this._controls.minDistance=t,this._controls.maxDistance=e)}setPolarLimits(t,e){this._controls&&(this._controls.minPolarAngle=t,this._controls.maxPolarAngle=e)}reset(){const t=j;this.setPosition(t.x,t.y,t.z),this.setTarget(0,0,0)}get positionTarget(){const t=this._camera;return{get x(){return t.position.x},set x(e){t.position.x=e},get y(){return t.position.y},set y(e){t.position.y=e},get z(){return t.position.z},set z(e){t.position.z=e}}}get positionObject(){const t=this._camera;return{get x(){return t.position.x},set x(e){t.position.x=e},get y(){return t.position.y},set y(e){t.position.y=e},get z(){return t.position.z},set z(e){t.position.z=e}}}getIntroStartPosition(){return{...ee}}getIntroEndPosition(){return{...j}}getIntroDuration(){return ie.introDuration}update(){this._isDisposed||this._controls&&this._controls.update()}dispose(){this._isDisposed||(this._resizeHandler&&(window.removeEventListener("renderer:resize",this._resizeHandler),this._resizeHandler=null),this._controls&&(this._controls.dispose(),this._controls=null),this._isDisposed=!0)}setupControls(t){this._controls=new Yt(this._camera,t),this._controls.target.set(0,0,0),this._controls.enableDamping=v.enableDamping,this._controls.dampingFactor=v.dampingFactor,this._controls.enableZoom=v.enableZoom,this._controls.enablePan=v.enablePan,this._controls.enableRotate=v.enableRotate,this._controls.minDistance=v.minDistance,this._controls.maxDistance=v.maxDistance,this._controls.minPolarAngle=v.minPolarAngle,this._controls.maxPolarAngle=v.maxPolarAngle,this._controls.autoRotate=v.autoRotate,this._controls.autoRotateSpeed=v.autoRotateSpeed,this._controls.update()}setupResizeHandling(){this._resizeHandler=()=>{const t=window.event;t?.detail&&this.updateAspect(t.detail.width,t.detail.height)},window.addEventListener("renderer:resize",this._resizeHandler)}}class oe{_callbacks=new Map;_isRunning=!1;_isPaused=!1;_animationFrameId=null;_lastTime=0;_elapsedTime=0;_frame=0;_maxDeltaTime;_targetFPS;_fpsInterval=0;_fpsHistory=[];_fpsHistorySize=60;constructor(t={}){this._maxDeltaTime=t.maxDeltaTime??.1,this._targetFPS=t.targetFPS??0,this._targetFPS>0&&(this._fpsInterval=1e3/this._targetFPS),this.loop=this.loop.bind(this),t.autoStart&&this.start()}get isRunning(){return this._isRunning}get isPaused(){return this._isPaused}get elapsedTime(){return this._elapsedTime}get frame(){return this._frame}get fps(){if(this._fpsHistory.length===0)return 0;const t=this._fpsHistory.reduce((e,i)=>e+i,0);return Math.round(t/this._fpsHistory.length)}get callbackCount(){return this._callbacks.size}add(t,e){return this._callbacks.set(t,e),()=>{this.remove(t)}}remove(t){return this._callbacks.delete(t)}has(t){return this._callbacks.has(t)}clear(){this._callbacks.clear()}start(){this._isRunning||(this._isRunning=!0,this._isPaused=!1,this._lastTime=performance.now(),this._animationFrameId=requestAnimationFrame(this.loop))}stop(){this._isRunning&&(this._isRunning=!1,this._isPaused=!1,this._animationFrameId!==null&&(cancelAnimationFrame(this._animationFrameId),this._animationFrameId=null))}pause(){this._isPaused=!0}resume(){this._isPaused&&(this._isPaused=!1,this._lastTime=performance.now())}togglePause(){return this._isPaused?this.resume():this.pause(),this._isPaused}reset(){this._elapsedTime=0,this._frame=0,this._fpsHistory=[],this._lastTime=performance.now()}tick(t){const e=t??.016666666666666666;this._elapsedTime+=e,this._frame++;for(const i of this._callbacks.values())try{i(e,this._elapsedTime,this._frame)}catch(s){console.error("AnimationLoop callback error:",s)}}dispose(){this.stop(),this.clear()}loop(t){if(!this._isRunning)return;if(this._animationFrameId=requestAnimationFrame(this.loop),this._isPaused){this._lastTime=t;return}let e=(t-this._lastTime)/1e3;if(this._targetFPS>0&&t-this._lastTime<this._fpsInterval)return;e=Math.min(e,this._maxDeltaTime),this._lastTime=t,this._elapsedTime+=e,this._frame++;const i=1/e;this._fpsHistory.push(i),this._fpsHistory.length>this._fpsHistorySize&&this._fpsHistory.shift();for(const s of this._callbacks.values())try{s(e,this._elapsedTime,this._frame)}catch(n){console.error("AnimationLoop callback error:",n)}}}const b={radius:5,widthSegments:64,heightSegments:64},ne={rotationSpeed:.1},E={roughness:.6,metalness:0,normalScale:.8},U={dayMap:"/STEM-Earth-Green/textures/2k_earth_daymap.jpg",nightMap:"/STEM-Earth-Green/textures/2k_earth_nightmap.jpg",cloudMap:"/STEM-Earth-Green/textures/2k_earth_clouds.jpg"},et={radius:5.05,rotationSpeed:.12};function c(o,t,e){return o+(t-o)*e}function f(o,t,e){return t>e?(console.warn(`clamp: min (${t}) is greater than max (${e}). Returning original value (${o}).`),o):Math.max(t,Math.min(e,o))}class Z{_material;_pollutionLevel=0;_cleanColor;_pollutedColor;_currentColor;_enableEmissive;_baseEmissiveIntensity=1;_isDisposed=!1;constructor(t={}){this._cleanColor=new l(m.earth.clean),this._pollutedColor=new l(m.earth.polluted),this._currentColor=this._cleanColor.clone(),this._enableEmissive=t.enableEmissive??!0,this._pollutionLevel=t.pollutionLevel??0,this._material=new I({color:16777215,roughness:t.roughness??E.roughness,metalness:t.metalness??E.metalness,normalScale:new y(E.normalScale,E.normalScale)}),t.textures&&this.applyTextures(t.textures),this.setPollutionLevel(this._pollutionLevel)}get material(){return this._material}get pollutionLevel(){return this._pollutionLevel}get currentColor(){return this._currentColor.clone()}get isDisposed(){return this._isDisposed}setPollutionLevel(t){if(this._isDisposed)return;this._pollutionLevel=f(t,0,100);const e=this._pollutionLevel/100,i=Math.max(0,(this._pollutionLevel-80)/20);this._currentColor.lerpColors(this._cleanColor,this._pollutedColor,e);const s=new l,n=new l(9127187),a=new l(2894892);s.lerpColors(n,a,i),this._material.color.lerpColors(new l(16777215),s,e*.6),this._enableEmissive&&this.updateEmissive(e),this.updateMaterialProperties(e,i),this._material.needsUpdate=!0}applyTextures(t){this._isDisposed||(t.dayMap&&(this._material.map=t.dayMap,t.dayMap.colorSpace=k),t.normalMap&&(this._material.normalMap=t.normalMap,this._material.normalScale.set(.8,.8)),t.specularMap&&(this._material.roughnessMap=t.specularMap,this._material.roughness=.5),this._material.needsUpdate=!0)}setEmissive(t,e=1){this._isDisposed||(this._material.emissive=new l(t),this._material.emissiveIntensity=e)}setNightMap(t){this._isDisposed||(this._material.emissiveMap=t,this._material.emissive=new l(16764040),this._material.emissiveIntensity=1,this._material.needsUpdate=!0)}setRoughness(t){this._isDisposed||(this._material.roughness=f(t,0,1))}setMetalness(t){this._isDisposed||(this._material.metalness=f(t,0,1))}getColorHex(){return"#"+this._currentColor.getHexString()}clone(){const t=new Z({pollutionLevel:this._pollutionLevel,roughness:this._material.roughness,metalness:this._material.metalness,enableEmissive:this._enableEmissive});return this._material.map&&(t._material.map=this._material.map),this._material.normalMap&&(t._material.normalMap=this._material.normalMap),this._material.emissiveMap&&(t._material.emissiveMap=this._material.emissiveMap),t}dispose(){this._isDisposed||(this._material.dispose(),this._isDisposed=!0)}updateEmissive(t){const e=Math.pow(t,.7),i=c(this._baseEmissiveIntensity,.1,e);this._material.emissiveIntensity=i;const s=new l(16764040),n=new l(5583633),a=new l;a.lerpColors(s,n,t),this._material.emissive=a}updateMaterialProperties(t,e=0){const i=E.roughness;this._material.roughness=c(i,.95,t*.7),this._material.metalness=c(0,.1,e);const s=c(.8,.2,t);this._material.normalScale.set(s,s)}}const ae=`
  varying vec2 vUv;
  varying vec3 vNormal;
  varying vec3 vPosition;
  varying vec3 vWorldNormal;
  
  void main() {
    vUv = uv;
    vNormal = normalize(normalMatrix * normal);
    vPosition = (modelViewMatrix * vec4(position, 1.0)).xyz;
    vWorldNormal = normalize((modelMatrix * vec4(normal, 0.0)).xyz);
    
    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }
`,re=`
  uniform sampler2D dayMap;
  uniform sampler2D nightMap;
  uniform sampler2D normalMap;
  uniform sampler2D specularMap;
  uniform sampler2D cloudsMap;
  
  uniform vec3 lightDirection;
  uniform vec3 lightColor;
  uniform float ambientIntensity;
  uniform float pollutionLevel;
  uniform vec3 pollutionTint;
  uniform float nightLightIntensity;
  
  varying vec2 vUv;
  varying vec3 vNormal;
  varying vec3 vPosition;
  varying vec3 vWorldNormal;
  
  void main() {
    // Sample textures
    vec4 dayColor = texture2D(dayMap, vUv);
    vec4 nightColor = texture2D(nightMap, vUv);
    
    // Calculate light intensity based on angle to sun
    float lightIntensity = dot(vWorldNormal, lightDirection);
    
    // Create smooth terminator (day/night transition)
    // Điều chỉnh để transition mượt hơn
    float dayFactor = smoothstep(-0.15, 0.25, lightIntensity);
    float nightFactor = 1.0 - dayFactor;
    
    // === DAY SIDE ===
    vec3 dayResult = dayColor.rgb;
    
    // Apply diffuse lighting to day side - tăng cường độ sáng
    float diffuse = max(lightIntensity, 0.0);
    // Tăng ambient và diffuse để sáng hơn
    dayResult *= (ambientIntensity * 1.5 + diffuse * 1.2);
    
    // Specular highlight on water (if specular map available)
    vec3 viewDir = normalize(-vPosition);
    vec3 reflectDir = reflect(-lightDirection, vNormal);
    float spec = pow(max(dot(viewDir, reflectDir), 0.0), 32.0);
    dayResult += spec * 0.5 * lightColor;  // Tăng specular để nước sáng bóng hơn
    
    // === NIGHT SIDE ===
    vec3 nightResult = nightColor.rgb;
    
    // City lights glow - affected by pollution (smog blocks light)
    float cityLightBrightness = nightLightIntensity * (1.0 - pollutionLevel * 0.009);
    nightResult *= cityLightBrightness;
    
    // Add more ambient to night side để không quá tối
    nightResult += dayColor.rgb * 0.08;  // Tăng từ 0.03 lên 0.08
    
    // === BLEND DAY AND NIGHT ===
    vec3 finalColor = mix(nightResult, dayResult, dayFactor);
    
    // === APPLY POLLUTION EFFECTS ===
    // Desaturation
    float gray = dot(finalColor, vec3(0.299, 0.587, 0.114));
    float desatAmount = pollutionLevel * 0.006;
    finalColor = mix(finalColor, vec3(gray), desatAmount);
    
    // Pollution tint overlay
    finalColor = mix(finalColor, pollutionTint, pollutionLevel * 0.004);
    
    gl_FragColor = vec4(finalColor, 1.0);
  }
`;class le{_material;_pollutionLevel=0;_lightDirection;_isDisposed=!1;constructor(t={}){this._pollutionLevel=t.pollutionLevel??0,this._lightDirection=t.lightDirection??new p(1,.3,.5).normalize(),this._material=new st({vertexShader:ae,fragmentShader:re,uniforms:{dayMap:{value:t.dayMap??null},nightMap:{value:t.nightMap??null},normalMap:{value:t.normalMap??null},specularMap:{value:t.specularMap??null},cloudsMap:{value:t.cloudsMap??null},lightDirection:{value:this._lightDirection},lightColor:{value:new l(16777215)},ambientIntensity:{value:.35},pollutionLevel:{value:this._pollutionLevel},pollutionTint:{value:new l(4864040)},nightLightIntensity:{value:1.5}},side:xt}),this.setPollutionLevel(this._pollutionLevel)}get material(){return this._material}get pollutionLevel(){return this._pollutionLevel}get isDisposed(){return this._isDisposed}setPollutionLevel(t){if(this._isDisposed)return;this._pollutionLevel=f(t,0,100),this._material.uniforms.pollutionLevel.value=this._pollutionLevel;const e=c(1.5,.2,this._pollutionLevel/100);this._material.uniforms.nightLightIntensity.value=e;const i=new l(4864040),s=new l(1710618),n=new l;n.lerpColors(i,s,this._pollutionLevel/100),this._material.uniforms.pollutionTint.value=n}setLightDirection(t){this._isDisposed||(this._lightDirection.copy(t).normalize(),this._material.uniforms.lightDirection.value=this._lightDirection)}setTextures(t){this._isDisposed||(t.dayMap&&(t.dayMap.colorSpace=k,this._material.uniforms.dayMap.value=t.dayMap),t.nightMap&&(t.nightMap.colorSpace=k,this._material.uniforms.nightMap.value=t.nightMap),t.normalMap&&(this._material.uniforms.normalMap.value=t.normalMap),t.specularMap&&(this._material.uniforms.specularMap.value=t.specularMap),t.cloudsMap&&(this._material.uniforms.cloudsMap.value=t.cloudsMap))}dispose(){this._isDisposed||(this._material.dispose(),this._isDisposed=!0)}}const it={dayMap:U.dayMap,nightMap:U.nightMap,cloudsMap:U.cloudMap};class he{_loader;_textures={dayMap:null,nightMap:null,cloudsMap:null,normalMap:null,specularMap:null};_isLoaded=!1;_isLoading=!1;_isDisposed=!1;constructor(){this._loader=new Ct}get isLoaded(){return this._isLoaded}get isLoading(){return this._isLoading}get isDisposed(){return this._isDisposed}get textures(){return{...this._textures}}get(t){return this._textures[t]}async loadAll(t){if(this._isLoaded)return this._textures;if(this._isLoading)return new Promise(n=>{const a=setInterval(()=>{this._isLoaded&&(clearInterval(a),n(this._textures))},100)});this._isLoading=!0;const e=Object.keys(it),i=e.length;let s=0;for(const n of e){const a=it[n];t&&t({loaded:s,total:i,percentage:Math.round(s/i*100),currentTexture:n});try{const r=await this.loadTexture(a);this._textures[n]=r}catch(r){console.warn(`Failed to load texture: ${n}`,r)}s++}return t&&t({loaded:i,total:i,percentage:100,currentTexture:"complete"}),this._isLoaded=!0,this._isLoading=!1,this._textures}loadTexture(t){return new Promise((e,i)=>{this._loader.load(t,s=>{s.colorSpace=k,s.anisotropy=16,e(s)},void 0,s=>{i(s)})})}preload(t){this.loadAll(t).catch(e=>{console.error("Failed to preload textures:",e)})}dispose(){if(!this._isDisposed){for(const t of Object.keys(this._textures)){const e=this._textures[t];e&&(e.dispose(),this._textures[t]=null)}this._isLoaded=!1,this._isDisposed=!0}}}let D=null;function ce(){return D||(D=new he),D}function pe(){D&&(D.dispose(),D=null)}class de{_mesh;_material;_pollutionLevel=0;_baseOpacity;_rotationSpeed;_cleanColor;_smogColor;_isDisposed=!1;constructor(t={}){const e=b.radius,i=t.heightOffset??et.radius-b.radius,s=e+i,n=b.widthSegments;this._baseOpacity=t.opacity??.4,this._rotationSpeed=et.rotationSpeed,this._pollutionLevel=t.pollutionLevel??0,this._cleanColor=new l(m.atmosphere.clouds),this._smogColor=new l(m.atmosphere.smog);const a=new Y(s,n,n);this._material=new I({color:this._cleanColor,transparent:!0,opacity:this._baseOpacity,side:St,depthWrite:!1,blending:ot,roughness:1,metalness:0}),t.cloudTexture&&(this._material.map=t.cloudTexture,this._material.alphaMap=t.cloudTexture),this._mesh=new V(a,this._material),this._mesh.name="clouds",this.setPollutionLevel(this._pollutionLevel)}get mesh(){return this._mesh}get material(){return this._material}get opacity(){return this._material.opacity}get pollutionLevel(){return this._pollutionLevel}get isDisposed(){return this._isDisposed}update(t){if(this._isDisposed)return;const e=c(1,.3,this._pollutionLevel/100);this._mesh.rotation.y+=this._rotationSpeed*t*e}setPollutionLevel(t){if(this._isDisposed)return;this._pollutionLevel=f(t,0,100);const e=this._pollutionLevel/100,i=c(this._baseOpacity,.85,Math.pow(e,.8));if(this._material.opacity=i,this._material.color.lerpColors(this._cleanColor,this._smogColor,e),e>.6){const n=(e-.6)/.4;this._material.emissive=new l(1707776),this._material.emissiveIntensity=n*.15}else this._material.emissiveIntensity=0;const s=c(1,1.03,e);this._mesh.scale.setScalar(s),this._material.needsUpdate=!0}setOpacity(t){this._isDisposed||(this._material.opacity=f(t,0,1))}setTexture(t){this._isDisposed||(this._material.map=t,this._material.alphaMap=t,this._material.needsUpdate=!0)}setRotationSpeed(t){this._rotationSpeed=t}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}toggle(){return this._mesh.visible=!this._mesh.visible,this._mesh.visible}dispose(){this._isDisposed||(this._mesh.geometry.dispose(),this._material.dispose(),this._isDisposed=!0)}}const ue=`
  varying vec3 vNormal;
  varying vec3 vPositionNormal;
  varying float vIntensity;
  
  void main() {
    vNormal = normalize(normalMatrix * normal);
    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
    vPositionNormal = normalize(mvPosition.xyz);
    
    // Pre-calculate fresnel intensity in vertex shader for smooth gradients
    float rawFresnel = 1.0 - abs(dot(vNormal, -vPositionNormal));
    vIntensity = rawFresnel;
    
    gl_Position = projectionMatrix * mvPosition;
  }
`,_e=`
  uniform vec3 glowColor;
  uniform vec3 innerColor;
  uniform float intensity;
  uniform float power;
  uniform float thickness;
  uniform float pollutionLevel;
  
  varying vec3 vNormal;
  varying vec3 vPositionNormal;
  varying float vIntensity;
  
  void main() {
    // Multi-power fresnel cho layered glow effect
    float fresnel = pow(vIntensity, power);
    float innerFresnel = pow(vIntensity, power * 0.5);
    
    // Outer glow - main atmosphere color
    vec3 outerGlow = glowColor * fresnel * intensity;
    
    // Inner glow - brighter edge
    vec3 innerGlow = innerColor * innerFresnel * intensity * 0.5;
    
    // Combine layers
    vec3 finalColor = outerGlow + innerGlow;
    
    // Alpha calculation - pollution increases opacity dramatically
    float baseAlpha = fresnel * intensity;
    float pollutionAlpha = pollutionLevel * 0.008; // Extra opacity from pollution
    float thicknessBoost = thickness * 0.3;
    
    // At high pollution, atmosphere becomes thick smog that obscures Earth
    float alpha = clamp(baseAlpha + pollutionAlpha + thicknessBoost, 0.0, 0.95);
    
    // Pollution adds a murky overlay
    if (pollutionLevel > 50.0) {
      float smogFactor = (pollutionLevel - 50.0) / 50.0;
      finalColor = mix(finalColor, glowColor * 0.3, smogFactor * 0.5);
      alpha = mix(alpha, 0.85, smogFactor * 0.6);
    }
    
    gl_FragColor = vec4(finalColor, alpha);
  }
`;class me{_mesh;_material;_pollutionLevel=0;_cleanColor;_pollutedColor;_baseIntensity;_baseThickness;_isDisposed=!1;constructor(t={}){const e=b.radius;this._baseThickness=t.thickness??1.12;const i=e*this._baseThickness,s=b.widthSegments;this._baseIntensity=t.intensity??.8,this._pollutionLevel=t.pollutionLevel??0,this._cleanColor=new l(m.atmosphere.clean),this._pollutedColor=new l(m.atmosphere.polluted);const n=new Y(i,s,s);this._material=new st({vertexShader:ue,fragmentShader:_e,uniforms:{glowColor:{value:this._cleanColor.clone()},innerColor:{value:new l(8965375)},intensity:{value:this._baseIntensity},power:{value:2.5},thickness:{value:0},pollutionLevel:{value:0}},side:Lt,transparent:!0,blending:nt,depthWrite:!1}),this._mesh=new V(n,this._material),this._mesh.name="atmosphere",this.setPollutionLevel(this._pollutionLevel)}get mesh(){return this._mesh}get material(){return this._material}get pollutionLevel(){return this._pollutionLevel}get isDisposed(){return this._isDisposed}setPollutionLevel(t){if(this._isDisposed)return;this._pollutionLevel=f(t,0,100);const e=this._pollutionLevel/100,i=new l;i.lerpColors(this._cleanColor,this._pollutedColor,e),this._material.uniforms.glowColor.value=i;const s=new l(8965375),n=new l(3815994),a=new l;a.lerpColors(s,n,e),this._material.uniforms.innerColor.value=a;const r=c(this._baseIntensity,this._baseIntensity*1.8,e);this._material.uniforms.intensity.value=r;const d=c(0,1,Math.pow(e,1.5));this._material.uniforms.thickness.value=d;const w=c(2.5,1.5,e);this._material.uniforms.power.value=w,this._material.uniforms.pollutionLevel.value=this._pollutionLevel;const M=c(1,1.15,Math.pow(e,2));this._mesh.scale.setScalar(M),this._material.needsUpdate=!0}setIntensity(t){this._isDisposed||(this._material.uniforms.intensity.value=f(t,0,2))}setPower(t){this._isDisposed||(this._material.uniforms.power.value=f(t,1,10))}setColor(t){this._isDisposed||(this._material.uniforms.glowColor.value=new l(t))}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}toggle(){return this._mesh.visible=!this._mesh.visible,this._mesh.visible}dispose(){this._isDisposed||(this._mesh.geometry.dispose(),this._material.dispose(),this._isDisposed=!0)}}class fe{_group;_mesh;_material=null;_shaderMaterial=null;_useDayNightShader;_clouds=null;_atmosphere=null;_textures;_pollutionLevel=0;_autoRotate;_rotationSpeed;_isDisposed=!1;constructor(t={}){this._pollutionLevel=t.pollutionLevel??0,this._autoRotate=t.autoRotate??!0,this._rotationSpeed=t.rotationSpeed??ne.rotationSpeed,this._useDayNightShader=t.useDayNightShader??!0,this._group=new at,this._group.name="earth-system";const e=new Y(b.radius,b.widthSegments,b.heightSegments);let i;this._useDayNightShader?(this._shaderMaterial=new le({pollutionLevel:this._pollutionLevel,dayMap:t.textures?.dayMap??void 0,nightMap:t.textures?.nightMap??void 0,normalMap:t.textures?.normalMap??void 0,specularMap:t.textures?.specularMap??void 0}),i=this._shaderMaterial.material):(this._material=new Z({...t.materialOptions,pollutionLevel:this._pollutionLevel,textures:t.textures}),i=this._material.material),this._mesh=new V(e,i),this._mesh.name="earth",this._group.add(this._mesh),t.enableClouds!==!1&&(this._clouds=new de({...t.cloudOptions,pollutionLevel:this._pollutionLevel,cloudTexture:t.textures?.cloudsMap??void 0}),this._group.add(this._clouds.mesh)),t.enableAtmosphere!==!1&&(this._atmosphere=new me({...t.atmosphereOptions,pollutionLevel:this._pollutionLevel}),this._group.add(this._atmosphere.mesh)),this._textures=ce()}get group(){return this._group}get mesh(){return this._mesh}get material(){return this._material}get shaderMaterial(){return this._shaderMaterial}get clouds(){return this._clouds}get atmosphere(){return this._atmosphere}get pollutionLevel(){return this._pollutionLevel}get rotation(){return this._mesh.rotation}get isDisposed(){return this._isDisposed}async loadTextures(t){const e=await this._textures.loadAll(t);this.applyTextures(e)}applyTextures(t){this._isDisposed||(this._useDayNightShader&&this._shaderMaterial?this._shaderMaterial.setTextures({dayMap:t.dayMap??void 0,nightMap:t.nightMap??void 0,normalMap:t.normalMap??void 0,specularMap:t.specularMap??void 0,cloudsMap:t.cloudsMap??void 0}):this._material&&(this._material.applyTextures(t),t.nightMap&&this._material.setNightMap(t.nightMap)),this._clouds&&t.cloudsMap&&this._clouds.setTexture(t.cloudsMap))}setPollutionLevel(t){this._isDisposed||(this._pollutionLevel=f(t,0,100),this._shaderMaterial&&this._shaderMaterial.setPollutionLevel(this._pollutionLevel),this._material&&this._material.setPollutionLevel(this._pollutionLevel),this._clouds?.setPollutionLevel(this._pollutionLevel),this._atmosphere?.setPollutionLevel(this._pollutionLevel))}update(t){this._isDisposed||(this._autoRotate&&(this._mesh.rotation.y+=this._rotationSpeed*t),this._clouds?.update(t))}setRotation(t,e,i){this._mesh.rotation.set(t,e,i)}setRotationSpeed(t){this._rotationSpeed=t}setAutoRotate(t){this._autoRotate=t}setCloudsVisible(t){this._clouds&&(t?this._clouds.show():this._clouds.hide())}setAtmosphereVisible(t){this._atmosphere&&(t?this._atmosphere.show():this._atmosphere.hide())}setPosition(t,e,i){this._group.position.set(t,e,i)}setScale(t){this._group.scale.setScalar(t)}dispose(){this._isDisposed||(this._material?.dispose(),this._shaderMaterial?.dispose(),this._clouds?.dispose(),this._atmosphere?.dispose(),this._mesh.geometry.dispose(),this._group.parent&&this._group.parent.remove(this._group),this._isDisposed=!0)}}class ge{_mesh;_geometry;_material;_count;_twinkle;_originalSizes=null;_twinkleSpeed=2;_time=0;_isDisposed=!1;constructor(t={}){this._count=t.count??5e3;const e=t.minDistance??50,i=t.maxDistance??300,s=t.size??.5,n=t.color??16777215;this._twinkle=t.twinkle??!1;const a=new Float32Array(this._count*3),r=new Float32Array(this._count);for(let d=0;d<this._count;d++){const w=Math.random()*Math.PI*2,M=Math.acos(2*Math.random()-1),C=e+Math.random()*(i-e),P=C*Math.sin(M)*Math.cos(w),z=C*Math.sin(M)*Math.sin(w),N=C*Math.cos(M);a[d*3]=P,a[d*3+1]=z,a[d*3+2]=N,r[d]=s*(.5+Math.random()*.5)}this._geometry=new rt,this._geometry.setAttribute("position",new T(a,3)),this._geometry.setAttribute("size",new T(r,1)),this._twinkle&&(this._originalSizes=new Float32Array(r)),this._material=new lt({color:new l(n),size:s,sizeAttenuation:!0,transparent:!0,opacity:1,blending:nt,depthWrite:!1}),this._mesh=new ht(this._geometry,this._material),this._mesh.name="starfield"}get mesh(){return this._mesh}get count(){return this._count}get isDisposed(){return this._isDisposed}update(t){if(this._isDisposed||!this._twinkle||!this._originalSizes)return;this._time+=t*this._twinkleSpeed;const e=this._geometry.attributes.size,i=e.array;for(let s=0;s<this._count;s++){const n=s*.01,a=.7+.3*Math.sin(this._time+n);i[s]=this._originalSizes[s]*a}e.needsUpdate=!0}setColor(t){this._isDisposed||(this._material.color=new l(t))}setOpacity(t){this._isDisposed||(this._material.opacity=f(t,0,1))}setSize(t){this._isDisposed||(this._material.size=t)}setTwinkle(t){if(this._twinkle=t,t&&!this._originalSizes){const e=this._geometry.attributes.size;this._originalSizes=new Float32Array(e.array)}}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}toggle(){return this._mesh.visible=!this._mesh.visible,this._mesh.visible}dispose(){this._isDisposed||(this._geometry.dispose(),this._material.dispose(),this._isDisposed=!0)}}class ye{_mesh;_geometry;_material;_particles=[];_maxParticles;_pollutionLevel=0;_earthRadius;_spawnTimer=0;_activeCount=0;_isDisposed=!1;constructor(t={}){this._maxParticles=t.maxParticles??500,this._pollutionLevel=t.pollutionLevel??0,this._earthRadius=t.earthRadius??b.radius;const e=t.color??m.effects.smoke;for(let a=0;a<this._maxParticles;a++)this._particles.push({position:new p,velocity:new p,life:0,maxLife:0,size:0,opacity:0});const i=new Float32Array(this._maxParticles*3),s=new Float32Array(this._maxParticles),n=new Float32Array(this._maxParticles);this._geometry=new rt,this._geometry.setAttribute("position",new T(i,3)),this._geometry.setAttribute("size",new T(s,1)),this._geometry.setAttribute("opacity",new T(n,1)),this._material=new lt({color:new l(e),size:.1,sizeAttenuation:!0,transparent:!0,opacity:.5,blending:ot,depthWrite:!1}),this._mesh=new ht(this._geometry,this._material),this._mesh.name="smoke-system",this._mesh.frustumCulled=!1}get mesh(){return this._mesh}get activeCount(){return this._activeCount}get pollutionLevel(){return this._pollutionLevel}get isDisposed(){return this._isDisposed}update(t){this._isDisposed||(this.spawnParticles(t),this.updateParticles(t),this.updateGeometry())}setPollutionLevel(t){if(this._isDisposed)return;this._pollutionLevel=f(t,0,100);const e=new l(m.effects.smoke),i=new l(m.effects.smokeDense),s=this._pollutionLevel/100;this._material.color.lerpColors(e,i,s);const n=c(.3,.8,s);this._material.opacity=n;const a=Math.max(0,(this._pollutionLevel-80)/20),r=c(.1,.25,a);this._material.size=r}setColor(t){this._isDisposed||(this._material.color=new l(t))}show(){this._mesh.visible=!0}hide(){this._mesh.visible=!1}clear(){for(const t of this._particles)t.life=0;this._activeCount=0,this.updateGeometry()}dispose(){this._isDisposed||(this._geometry.dispose(),this._material.dispose(),this._isDisposed=!0)}spawnParticles(t){if(this._pollutionLevel<30)return;let e;if(this._pollutionLevel<=80){const s=(this._pollutionLevel-30)/50;e=c(5,30,s)}else{const s=(this._pollutionLevel-80)/20;e=30+Math.pow(s,2)*120}this._spawnTimer+=t;const i=1/e;for(;this._spawnTimer>=i;)this._spawnTimer-=i,this.spawnParticle()}spawnParticle(){const t=this._particles.find(r=>r.life<=0);if(!t)return;const e=Math.random()*Math.PI*2,i=Math.acos(2*Math.random()-1),s=this._earthRadius*1.05;t.position.set(s*Math.sin(i)*Math.cos(e),s*Math.sin(i)*Math.sin(e),s*Math.cos(i));const n=t.position.clone().normalize(),a=new p(0,1,0);t.velocity.copy(n).multiplyScalar(.2).add(a.multiplyScalar(.1+Math.random()*.1)),t.velocity.x+=(Math.random()-.5)*.1,t.velocity.y+=(Math.random()-.5)*.1,t.velocity.z+=(Math.random()-.5)*.1,t.maxLife=2+Math.random()*2,t.life=t.maxLife,t.size=.05+Math.random()*.1,t.opacity=.3+Math.random()*.3,this._activeCount++}updateParticles(t){this._activeCount=0;for(const e of this._particles){if(e.life<=0||(e.life-=t,e.life<=0))continue;this._activeCount++,e.position.add(e.velocity.clone().multiplyScalar(t)),e.velocity.multiplyScalar(.99),e.size*=1.01;const i=e.life/e.maxLife;e.opacity=c(0,.5,i)}}updateGeometry(){const t=this._geometry.attributes.position,e=t.array;for(let i=0;i<this._particles.length;i++){const s=this._particles[i];s.life>0?(e[i*3]=s.position.x,e[i*3+1]=s.position.y,e[i*3+2]=s.position.z):(e[i*3]=0,e[i*3+1]=-1e3,e[i*3+2]=0)}t.needsUpdate=!0}}class ve{_group;_meshes;_particles=[];_maxParticles;_pollutionLevel=0;_earthRadius;_orbitHeight;_spawnTimer=0;_activeCount=0;_dummy;_isDisposed=!1;constructor(t={}){this._maxParticles=t.maxParticles??200,this._pollutionLevel=t.pollutionLevel??0,this._earthRadius=t.earthRadius??b.radius,this._orbitHeight=t.orbitHeight??.2,this._group=new at,this._group.name="trash-system",this._dummy=new Dt;for(let e=0;e<this._maxParticles;e++)this._particles.push({position:new p,velocity:new p,rotation:new Pt,rotationSpeed:new p,scale:1,active:!1});this._meshes=this.createTrashMeshes(),this.updateGeometry()}get mesh(){return this._group}get activeCount(){return this._activeCount}get pollutionLevel(){return this._pollutionLevel}get isDisposed(){return this._isDisposed}update(t){this._isDisposed||(this.spawnParticles(t),this.updateParticles(t),this.updateGeometry())}setPollutionLevel(t){this._isDisposed||(this._pollutionLevel=f(t,0,100),this._pollutionLevel<60&&this.reduceParticles())}show(){this._group.visible=!0}hide(){this._group.visible=!1}clear(){for(const t of this._particles)t.active=!1;this._activeCount=0,this.updateGeometry()}dispose(){if(!this._isDisposed){for(const t of this._meshes)t.geometry.dispose(),t.material instanceof Et&&t.material.dispose();this._isDisposed=!0}}createTrashMeshes(){const t=[],e=new Tt(.02,.04,.02),i=new I({color:m.effects.plasticTrash,roughness:.8}),s=new Q(e,i,Math.floor(this._maxParticles/2));s.name="trash-boxes",t.push(s),this._group.add(s);const n=new kt(.015,0),a=new I({color:m.effects.metalTrash,roughness:.6}),r=new Q(n,a,Math.floor(this._maxParticles/2));return r.name="trash-spheres",t.push(r),this._group.add(r),t}spawnParticles(t){if(this._pollutionLevel<40)return;let e;if(this._pollutionLevel<=80){const s=(this._pollutionLevel-40)/40;e=c(2,15,s)}else{const s=(this._pollutionLevel-80)/20;e=15+Math.pow(s,1.8)*45}this._spawnTimer+=t;const i=1/e;for(;this._spawnTimer>=i;)this._spawnTimer-=i,this.spawnParticle()}spawnParticle(){const t=this._particles.find(ut=>!ut.active);if(!t)return;const e=Math.random()*Math.PI*2,i=Math.acos(2*Math.random()-1),s=Math.max(0,(this._pollutionLevel-80)/20),n=c(.3,.8,s),a=this._earthRadius+this._orbitHeight+Math.random()*n;t.position.set(a*Math.sin(i)*Math.cos(e),a*Math.sin(i)*Math.sin(e),a*Math.cos(i));const r=t.position.clone().normalize(),d=new p().crossVectors(r,new p(0,1,0)).normalize();d.length()<.01&&d.crossVectors(r,new p(1,0,0)).normalize();const M=c(.05,.12,s)+Math.random()*.05;t.velocity.copy(d).multiplyScalar(M);const C=c(.02,.06,s);t.velocity.add(r.multiplyScalar(-C+Math.random()*C*2)),t.rotation.set(Math.random()*Math.PI*2,Math.random()*Math.PI*2,Math.random()*Math.PI*2);const P=c(2,4,s);t.rotationSpeed.set((Math.random()-.5)*P,(Math.random()-.5)*P,(Math.random()-.5)*P);const z=c(.5,.8,s),N=c(1.5,2.5,s);t.scale=z+Math.random()*N,t.active=!0,this._activeCount++}updateParticles(t){this._activeCount=0;for(const e of this._particles){if(!e.active)continue;this._activeCount++,e.position.add(e.velocity.clone().multiplyScalar(t)),e.rotation.x+=e.rotationSpeed.x*t,e.rotation.y+=e.rotationSpeed.y*t,e.rotation.z+=e.rotationSpeed.z*t;const i=e.position.length();(i>this._earthRadius*2||i<this._earthRadius*.9)&&(e.active=!1)}}reduceParticles(){const t=this._pollutionLevel/60,e=Math.floor(c(0,this._maxParticles*.3,t));let i=this._activeCount-e;for(const s of this._particles){if(i<=0)break;s.active&&(s.active=!1,i--)}}updateGeometry(){const t=Math.floor(this._maxParticles/2);let e=0,i=0;for(let s=0;s<this._particles.length;s++){const n=this._particles[s],a=s<t?0:1,r=this._meshes[a],d=a===0?e++:i++;n.active?(this._dummy.position.copy(n.position),this._dummy.rotation.copy(n.rotation),this._dummy.scale.setScalar(n.scale)):(this._dummy.position.set(0,-1e3,0),this._dummy.scale.setScalar(0)),this._dummy.updateMatrix(),r.setMatrixAt(d,this._dummy.matrix)}for(const s of this._meshes)s.instanceMatrix.needsUpdate=!0}}class be{_container;_sliderContainer;_slider;_label=null;_value;_min;_max;_onChange;_labelFormatter;_isDisposed=!1;constructor(t={}){this._container=this.resolveContainer(t.container),this._min=t.min??0,this._max=t.max??100,this._value=t.initialValue??0,this._onChange=t.onChange??null,this._labelFormatter=t.labelFormatter??(e=>`${Math.round(e)}%`),this._sliderContainer=this.createSliderContainer(),this._slider=this.createSlider(t.step??1),t.showLabel!==!1&&(this._label=this.createLabel()),this._sliderContainer.appendChild(this._slider),this._label&&this._sliderContainer.appendChild(this._label),this._container.appendChild(this._sliderContainer),this.setValue(this._value),this.bindEvents()}get value(){return this._value}get element(){return this._sliderContainer}get isDisposed(){return this._isDisposed}setValue(t,e=!0){this._isDisposed||(this._value=f(t,this._min,this._max),this._slider.value=String(this._value),this._label&&(this._label.textContent=this._labelFormatter(this._value)),this.updateSliderGradient(),e&&this._onChange&&this._onChange(this._value))}setOnChange(t){this._onChange=t}enable(){this._isDisposed||(this._slider.disabled=!1,this._sliderContainer.style.opacity="1",this._sliderContainer.style.pointerEvents="auto")}disable(){this._isDisposed||(this._slider.disabled=!0,this._sliderContainer.style.opacity="0.5",this._sliderContainer.style.pointerEvents="none")}show(){this._isDisposed||(this._sliderContainer.style.display="flex")}hide(){this._isDisposed||(this._sliderContainer.style.display="none")}dispose(){this._isDisposed||(this._slider.removeEventListener("input",this.handleInput),this._sliderContainer.parentNode&&this._sliderContainer.parentNode.removeChild(this._sliderContainer),this._isDisposed=!0)}resolveContainer(t){if(!t)return document.body;if(typeof t=="string"){const e=document.querySelector(t);return e||(console.warn(`Container not found: ${t}, using body`),document.body)}return t}createSliderContainer(){const t=document.createElement("div");return t.className="pollution-slider-container",t.style.cssText=`
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 20px 30px;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 100;
      font-family: 'Segoe UI', system-ui, sans-serif;
    `,t}createSlider(t){const e=document.createElement("input");return e.type="range",e.min=String(this._min),e.max=String(this._max),e.step=String(t),e.value=String(this._value),e.className="pollution-slider",e.setAttribute("aria-label","Mức độ ô nhiễm"),e.style.cssText=`
      width: 300px;
      height: 8px;
      border-radius: 4px;
      outline: none;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
    `,this.addSliderStyles(),e}createLabel(){const t=document.createElement("div");t.style.cssText=`
      display: flex;
      justify-content: space-between;
      width: 100%;
      color: white;
      font-size: 14px;
    `;const e=document.createElement("span");e.textContent="Mức ô nhiễm:",e.style.opacity="0.8";const i=document.createElement("span");return i.className="pollution-value",i.textContent=this._labelFormatter(this._value),i.style.fontWeight="bold",t.appendChild(e),t.appendChild(i),t.querySelector(".pollution-value")}addSliderStyles(){const t="pollution-slider-styles";if(document.getElementById(t))return;const e=document.createElement("style");e.id=t,e.textContent=`
      .pollution-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: white;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.8);
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .pollution-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      }
      
      .pollution-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: white;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.8);
      }
      
      .pollution-slider::-webkit-slider-runnable-track {
        height: 8px;
        border-radius: 4px;
      }
      
      .pollution-slider::-moz-range-track {
        height: 8px;
        border-radius: 4px;
      }
    `,document.head.appendChild(e)}updateSliderGradient(){const t=(this._value-this._min)/(this._max-this._min)*100,e=m.earth.clean,i=m.earth.polluted;this._slider.style.background=`
      linear-gradient(90deg, 
        ${e} 0%, 
        ${i} 100%
      )
    `,this._slider.style.background=`
      linear-gradient(90deg, 
        ${e} 0%, 
        ${i} ${t}%,
        rgba(255, 255, 255, 0.2) ${t}%,
        rgba(255, 255, 255, 0.2) 100%
      )
    `}bindEvents(){this.handleInput=this.handleInput.bind(this),this._slider.addEventListener("input",this.handleInput)}handleInput=()=>{const t=parseFloat(this._slider.value);this.setValue(t,!0)}}const _={CLEAN:"clean",LIGHT:"light",MODERATE:"moderate",SEVERE:"severe"},O={[_.CLEAN]:{min:0,max:20,label:"clean",description:"Trái Đất trong lành, không khí sạch",color:m.ui.success},[_.LIGHT]:{min:21,max:50,label:"light",description:"Bắt đầu xuất hiện ô nhiễm nhẹ",color:m.ui.accent},[_.MODERATE]:{min:51,max:80,label:"moderate",description:"Ô nhiễm trung bình, cần hành động",color:m.ui.warning},[_.SEVERE]:{min:81,max:100,label:"severe",description:"Ô nhiễm nghiêm trọng, nguy hiểm",color:m.ui.error}},we={[_.CLEAN]:{showSmoke:!1,trashDensity:0,oceanOpacity:1,showForests:!0},[_.LIGHT]:{showSmoke:!1,trashDensity:10,oceanOpacity:.9,showForests:!0},[_.MODERATE]:{showSmoke:!0,trashDensity:40,oceanOpacity:.7,showForests:!0},[_.SEVERE]:{showSmoke:!0,trashDensity:80,oceanOpacity:.4,showForests:!1}};function R(o){const t=Math.max(0,Math.min(100,o));for(const[e,i]of Object.entries(O))if(t>=i.min&&t<=i.max)return e;return _.CLEAN}function Me(o){return O[o]}function pt(o){return Math.max(0,Math.min(100,o))/100}function xe(o){const t=R(o);return O[t].description}class Ce{_container;_panel;_titleElement=null;_levelElement;_messageElement;_effectsElement;_value=0;_isDisposed=!1;constructor(t={}){this._container=this.resolveContainer(t.container),this._panel=this.createPanel(t.position??"top-right"),t.showTitle!==!1&&(this._titleElement=this.createTitle(),this._panel.appendChild(this._titleElement)),this._levelElement=this.createLevelDisplay(),this._messageElement=this.createMessageDisplay(),this._effectsElement=this.createEffectsDisplay(),this._panel.appendChild(this._levelElement),this._panel.appendChild(this._messageElement),this._panel.appendChild(this._effectsElement),this._container.appendChild(this._panel),this.update(t.initialValue??0)}get element(){return this._panel}get value(){return this._value}get isDisposed(){return this._isDisposed}update(t){if(this._isDisposed)return;this._value=f(t,0,100);const e=this.getPollutionInfo(this._value);this.updateLevelDisplay(e),this.updateMessageDisplay(e),this.updateEffectsDisplay(e),this._panel.style.borderColor=e.color}show(){this._isDisposed||(this._panel.style.opacity="1",this._panel.style.transform="translateY(0)")}hide(){this._isDisposed||(this._panel.style.opacity="0",this._panel.style.transform="translateY(-20px)")}dispose(){this._isDisposed||(this._panel.parentNode&&this._panel.parentNode.removeChild(this._panel),this._isDisposed=!0)}resolveContainer(t){if(!t)return document.body;if(typeof t=="string"){const e=document.querySelector(t);return e||(console.warn(`Container not found: ${t}, using body`),document.body)}return t}createPanel(t){const e=document.createElement("div");e.className="info-panel";let i="";switch(t){case"top-left":i="top: 20px; left: 20px;";break;case"top-right":i="top: 20px; right: 20px;";break;case"bottom-left":i="bottom: 100px; left: 20px;";break;case"bottom-right":i="bottom: 100px; right: 20px;";break}return e.style.cssText=`
      position: fixed;
      ${i}
      min-width: 280px;
      max-width: 320px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      color: white;
      font-family: 'Segoe UI', system-ui, sans-serif;
      z-index: 100;
      transition: all 0.3s ease;
    `,e}createTitle(){const t=document.createElement("h3");return t.textContent="Trạng thái Trái Đất",t.style.cssText=`
      margin: 0 0 16px 0;
      font-size: 16px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.9;
    `,t}createLevelDisplay(){const t=document.createElement("div");t.className="level-display",t.style.cssText=`
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 12px;
    `;const e=document.createElement("span");e.textContent="Ô nhiễm:",e.style.opacity="0.7";const i=document.createElement("span");i.className="level-value",i.style.cssText=`
      font-size: 32px;
      font-weight: bold;
    `;const s=document.createElement("span");return s.className="level-badge",s.style.cssText=`
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    `,t.appendChild(e),t.appendChild(i),t.appendChild(s),t}createMessageDisplay(){const t=document.createElement("p");return t.className="message-display",t.style.cssText=`
      margin: 0 0 16px 0;
      font-size: 14px;
      line-height: 1.5;
      opacity: 0.9;
    `,t}createEffectsDisplay(){const t=document.createElement("div");t.className="effects-display";const e=document.createElement("h4");e.textContent="Tác động:",e.style.cssText=`
      margin: 0 0 8px 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      opacity: 0.7;
    `;const i=document.createElement("ul");return i.className="effects-list",i.style.cssText=`
      margin: 0;
      padding-left: 20px;
      font-size: 13px;
      line-height: 1.6;
      opacity: 0.85;
    `,t.appendChild(e),t.appendChild(i),t}getPollutionInfo(t){const e=R(t),i=xe(t),s=this.getEffectsForLevel(e,t),n=this.getColorForLevel(e);return{level:e,percentage:t,message:i,effects:s,color:n}}getEffectsForLevel(t,e){const i=[];switch(t){case _.CLEAN:i.push("Không khí trong lành"),i.push("Hệ sinh thái cân bằng"),i.push("Nước sạch, an toàn");break;case _.LIGHT:i.push("Chất lượng không khí tốt"),i.push("Một số khu vực bắt đầu ô nhiễm nhẹ");break;case _.MODERATE:i.push("Ô nhiễm không khí nhẹ"),i.push("Một số loài bị ảnh hưởng"),i.push("Cần giảm khí thải");break;case _.SEVERE:i.push("⚠️ MỨC NGUY HIỂM"),i.push("Ô nhiễm không khí nghiêm trọng"),i.push("Nhiều loài bị đe dọa"),i.push("Sức khỏe con người bị ảnh hưởng"),i.push("Cần hành động ngay!");break}return e>50&&i.push("🏭 Khói công nghiệp phát sinh"),e>60&&i.push("🗑️ Rác thải tràn ngập"),e>70&&i.push("🌊 Đại dương bị ô nhiễm"),i}getColorForLevel(t){return O[t].color}updateLevelDisplay(t){const e=this._levelElement.querySelector(".level-value"),i=this._levelElement.querySelector(".level-badge");e&&(e.textContent=`${Math.round(t.percentage)}%`,e.style.color=t.color),i&&(i.textContent=this.getLevelText(t.level),i.style.background=t.color,i.style.color=t.level===_.CLEAN||t.level===_.LIGHT?"black":"white")}getLevelText(t){switch(t){case _.CLEAN:return"Trong lành";case _.LIGHT:return"Nhẹ";case _.MODERATE:return"Trung bình";case _.SEVERE:return"Nghiêm trọng";default:return"N/A"}}updateMessageDisplay(t){this._messageElement.textContent=t.message}updateEffectsDisplay(t){const e=this._effectsElement.querySelector(".effects-list");if(e){e.innerHTML="";for(const i of t.effects){const s=document.createElement("li");s.textContent=i,e.appendChild(s)}}}}class Se{_container;_overlay;_content;_button;_onStart;_autoHide;_isDisposed=!1;_isVisible=!0;constructor(t={}){this._container=this.resolveContainer(t.container),this._onStart=t.onStart??null,this._autoHide=t.autoHide??!0,this._overlay=this.createOverlay(),this._content=this.createContent(t.title??"Trái Đất Xanh",t.subtitle??"Hai Tương Lai"),this._button=this.createButton(t.buttonText??"Bắt đầu"),this._content.appendChild(this._button),this._overlay.appendChild(this._content),this._container.appendChild(this._overlay),this.bindEvents()}get element(){return this._overlay}get isVisible(){return this._isVisible}get isDisposed(){return this._isDisposed}show(){this._isDisposed||(this._overlay.style.opacity="1",this._overlay.style.visibility="visible",this._isVisible=!0,requestAnimationFrame(()=>{this._content.style.opacity="1",this._content.style.transform="translateY(0)"}))}hide(){return this._isDisposed?Promise.resolve():new Promise(t=>{this._content.style.opacity="0",this._content.style.transform="translateY(20px)",setTimeout(()=>{this._overlay.style.opacity="0",setTimeout(()=>{this._overlay.style.visibility="hidden",this._isVisible=!1,t()},500)},300)})}setOnStart(t){this._onStart=t}dispose(){this._isDisposed||(this._button.removeEventListener("click",this.handleStart),this._overlay.parentNode&&this._overlay.parentNode.removeChild(this._overlay),this._isDisposed=!0)}resolveContainer(t){if(!t)return document.body;if(typeof t=="string"){const e=document.querySelector(t);return e||(console.warn(`Container not found: ${t}, using body`),document.body)}return t}createOverlay(){const t=document.createElement("div");return t.className="intro-overlay",t.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a1628 0%, #1a2a4a 50%, #0f1f35 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.5s ease;
    `,t}createContent(t,e){const i=document.createElement("div");i.className="intro-content",i.style.cssText=`
      text-align: center;
      color: white;
      font-family: 'Segoe UI', system-ui, sans-serif;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.5s ease;
    `;const s=document.createElement("div");s.innerHTML="🌍",s.style.cssText=`
      font-size: 80px;
      margin-bottom: 24px;
      animation: float 3s ease-in-out infinite;
    `;const n=document.createElement("h1");n.textContent=t,n.style.cssText=`
      font-size: 48px;
      font-weight: 700;
      margin: 0 0 12px 0;
      background: linear-gradient(90deg, #4CAF50, #8BC34A, #4CAF50);
      background-size: 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradient 3s ease infinite;
    `;const a=document.createElement("p");return a.textContent=e,a.style.cssText=`
      font-size: 24px;
      font-weight: 300;
      margin: 0 0 40px 0;
      opacity: 0.8;
    `,this.addAnimationStyles(),i.appendChild(s),i.appendChild(n),i.appendChild(a),i}createButton(t){const e=document.createElement("button");return e.textContent=t,e.className="intro-button",e.style.cssText=`
      padding: 16px 48px;
      font-size: 18px;
      font-weight: 600;
      color: white;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      border: none;
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    `,e.addEventListener("mouseenter",()=>{e.style.transform="translateY(-2px)",e.style.boxShadow="0 6px 20px rgba(76, 175, 80, 0.5)"}),e.addEventListener("mouseleave",()=>{e.style.transform="translateY(0)",e.style.boxShadow="0 4px 15px rgba(76, 175, 80, 0.4)"}),e}addAnimationStyles(){const t="intro-animation-styles";if(document.getElementById(t))return;const e=document.createElement("style");e.id=t,e.textContent=`
      @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
      }
      
      @keyframes gradient {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
    `,document.head.appendChild(e)}bindEvents(){this.handleStart=this.handleStart.bind(this),this._button.addEventListener("click",this.handleStart)}handleStart=()=>{this._button.disabled=!0,this._button.textContent="Đang tải...",this._onStart&&this._onStart(),this._autoHide&&this.hide()}}class Le{_cameraManager;_timeline=null;_duration;_startDistance;_endDistance;_ease;_onComplete;_onUpdate;_isPlaying=!1;_isCompleted=!1;_isDisposed=!1;constructor(t){this._cameraManager=t.cameraManager,this._duration=t.duration??3,this._startDistance=t.startDistance??20,this._endDistance=t.endDistance??this._cameraManager.position.z,this._ease=t.ease??"power2.out",this._onComplete=t.onComplete??null,this._onUpdate=t.onUpdate??null}get isPlaying(){return this._isPlaying}get isCompleted(){return this._isCompleted}get isDisposed(){return this._isDisposed}get progress(){return this._timeline?this._timeline.progress():0}setStartPosition(){this._isDisposed||(this._cameraManager.setPosition(0,0,this._startDistance),this._cameraManager.setTarget(0,0,0))}play(){return this._isDisposed||this._isPlaying||this._isCompleted?Promise.resolve():new Promise(t=>{this._isPlaying=!0,this._cameraManager.setPosition(0,0,this._startDistance),this._cameraManager.setTarget(0,0,0),this._timeline=Rt.timeline({onComplete:()=>{this._isPlaying=!1,this._isCompleted=!0,this._cameraManager.setTarget(0,0,0),this._cameraManager.enableControls(),this._onComplete&&this._onComplete(),t()},onUpdate:()=>{this._onUpdate&&this._timeline&&this._onUpdate(this._timeline.progress())}}),this._cameraManager.disableControls();const e=this._cameraManager.positionTarget;this._timeline.to(e,{z:this._endDistance,duration:this._duration,ease:this._ease})})}skip(){this._isDisposed||this._isCompleted||(this._timeline&&(this._timeline.kill(),this._timeline=null),this._cameraManager.setPosition(0,0,this._endDistance),this._cameraManager.enableControls(),this._isPlaying=!1,this._isCompleted=!0,this._onComplete&&this._onComplete())}pause(){this._timeline&&this._isPlaying&&this._timeline.pause()}resume(){this._timeline&&this._isPlaying&&this._timeline.resume()}reset(){this._isDisposed||(this._timeline&&(this._timeline.kill(),this._timeline=null),this._isPlaying=!1,this._isCompleted=!1,this.setStartPosition(),this._cameraManager.disableControls())}setOnComplete(t){this._onComplete=t}setOnUpdate(t){this._onUpdate=t}dispose(){this._isDisposed||(this._timeline&&(this._timeline.kill(),this._timeline=null),this._isDisposed=!0)}}function De(o){const t=R(o),e=Me(t),i=we[t];return{level:t,value:o,normalizedValue:pt(o),label:e.label,description:e.description,range:{min:e.min,max:e.max},effects:{showSmoke:i.showSmoke,trashDensity:i.trashDensity,oceanOpacity:i.oceanOpacity,showForests:i.showForests}}}function Pe(o,t){const e=R(o),i=R(t);return e!==i}function Ee(o){return pt(o)}function Te(o){const t=[];return typeof o!="number"||isNaN(o)?(t.push("Value is not a number"),{valid:!1,value:NaN,errors:t}):(o<0&&t.push("Value is below minimum (0)"),o>100&&t.push("Value exceeds maximum (100)"),isFinite(o)||t.push("Value must be finite"),{valid:t.length===0,value:o,errors:t})}class K{_pollutionLevel=0;_rotation=0;_scale=1;_listeners=new Set;_pollutionHistory=[];MAX_HISTORY_SIZE=100;constructor(t=0){this.setPollution(t,{silent:!0})}getPollutionLevel(){return this._pollutionLevel}getNormalizedPollution(){return this._pollutionLevel/100}getPollutionSeverity(){return Ee(this._pollutionLevel)}getPollutionInfo(){return De(this._pollutionLevel)}getPollutionHistory(){return[...this._pollutionHistory]}setPollution(t,e={}){const{silent:i=!1,skipValidator:s=!1}=e;if(!s){const r=Te(t);if(!r.valid)throw new Error(`Invalid pollution value: ${r.errors.join(", ")}`)}const n=f(t,0,100);if(n===this._pollutionLevel)return;const a=this.getSnapshot();this._pollutionLevel=n,this._pollutionHistory.push(n),this._pollutionHistory.length>this.MAX_HISTORY_SIZE&&this._pollutionHistory.shift(),i||this.emitChange("pollution_changed",a)}incrementPollution(t){const e=this._pollutionLevel+t;return this.setPollution(e),this._pollutionLevel}resetPollution(){this.setPollution(0)}getRotation(){return this._rotation}setRotation(t,e={}){const{silent:i=!1}=e;if(t===this._rotation)return;const s=this.getSnapshot();this._rotation=t,i||this.emitChange("rotation_changed",s)}incrementRotation(t){return this.setRotation(this._rotation+t),this._rotation}resetRotation(){this.setRotation(0)}getScale(){return this._scale}setScale(t,e={}){const{silent:i=!1}=e;if(t<=0)throw new Error("Scale must be greater than 0");if(t===this._scale)return;const s=this.getSnapshot();this._scale=t,i||this.emitChange("scale_changed",s)}resetScale(){this.setScale(1)}getSnapshot(){return Object.freeze({pollutionLevel:this._pollutionLevel,rotation:this._rotation,scale:this._scale})}restoreSnapshot(t,e={}){const{silent:i=!1}=e,s=this.getSnapshot();this._pollutionLevel=f(t.pollutionLevel,0,100),this._rotation=t.rotation,this._scale=t.scale,i||this.emitChange("state_reset",s)}addListener(t){return this._listeners.add(t),()=>{this._listeners.delete(t)}}removeListener(t){this._listeners.delete(t)}removeAllListeners(){this._listeners.clear()}emitChange(t,e){const i={type:t,oldState:e,newState:this.getSnapshot(),timestamp:Date.now()};this._listeners.forEach(s=>{try{s(i)}catch(n){console.error("Error in state change listener:",n)}})}hasPollutionLevelChanged(){if(this._pollutionHistory.length<2)return!1;const t=this._pollutionHistory[this._pollutionHistory.length-1],e=this._pollutionHistory[this._pollutionHistory.length-2];return Pe(e,t)}toJSON(){return JSON.stringify({pollutionLevel:this._pollutionLevel,rotation:this._rotation,scale:this._scale,history:this._pollutionHistory,timestamp:Date.now()})}fromJSON(t,e={}){try{const i=JSON.parse(t);this.restoreSnapshot({pollutionLevel:i.pollutionLevel??0,rotation:i.rotation??0,scale:i.scale??1},e),Array.isArray(i.history)&&(this._pollutionHistory=i.history)}catch(i){throw new Error(`Failed to parse state JSON: ${i}`)}}clone(){const t=new K(this._pollutionLevel);return t._rotation=this._rotation,t._scale=this._scale,t._pollutionHistory=[...this._pollutionHistory],t}toString(){const t=this.getPollutionInfo();return`EarthState { pollution: ${this._pollutionLevel}% (${t.label}), rotation: ${this._rotation.toFixed(2)}, scale: ${this._scale.toFixed(2)} }`}}class ke{renderer;sceneManager;cameraManager;animationLoop;earth;starfield;smokeSystem;trashSystem;slider;infoPanel;introScreen;introController;earthState;_cameraCentered=!1;async init(){try{this.setupContainer(),this.initCore(),await this.initEarth(),this.initEffects(),this.initState(),this.initUI(),this.setupEventHandlers(),this.animationLoop.start(),console.log("🌍 Trái Đất Xanh initialized successfully!")}catch(t){console.error("Failed to initialize application:",t),this.showError("Không thể khởi tạo ứng dụng. Vui lòng tải lại trang.")}}setupContainer(){const t=document.querySelector("#app");if(!t)throw new Error("App container not found");t.innerHTML="",t.style.cssText=`
      width: 100vw;
      height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
    `}initCore(){this.renderer=new At({container:"#app"}),this.sceneManager=new jt,this.cameraManager=new se({domElement:this.renderer.domElement}),this.animationLoop=new oe}async initEarth(){this.earth=new fe({pollutionLevel:0,enableClouds:!0,enableAtmosphere:!0,autoRotate:!0}),this.sceneManager.add(this.earth.group,"earth"),this.earth.loadTextures(t=>{console.log(`Loading textures: ${t.percentage}%`)}).catch(t=>{console.warn("Some textures failed to load:",t)})}initEffects(){this.starfield=new ge({count:5e3,twinkle:!0}),this.sceneManager.add(this.starfield.mesh,"starfield"),this.smokeSystem=new ye({pollutionLevel:0}),this.sceneManager.add(this.smokeSystem.mesh,"smoke"),this.trashSystem=new ve({pollutionLevel:0}),this.sceneManager.add(this.trashSystem.mesh,"trash")}initState(){this.earthState=new K,this.earthState.addListener(t=>{this.onPollutionChange(t.newState.pollutionLevel)})}initUI(){this.introScreen=new Se({title:"Trái Đất Xanh",subtitle:"Hai Tương Lai",buttonText:"Khám Phá",onStart:()=>this.startExperience()}),this.introScreen.show(),this.introController=new Le({cameraManager:this.cameraManager,duration:3,startDistance:20,endDistance:15,onComplete:()=>this.onIntroComplete()}),this.slider=new be({initialValue:0,onChange:t=>{this.earthState.setPollution(t)}}),this.slider.disable(),this.infoPanel=new Ce({position:"top-right",initialValue:0}),this.infoPanel.hide()}setupEventHandlers(){this.animationLoop.add("main",t=>{this._cameraCentered||(this.centerCamera(),this._cameraCentered=!0),this.earth.update(t),this.starfield.update(t),this.smokeSystem.update(t),this.trashSystem.update(t),this.cameraManager.update(),this.renderer.render(this.sceneManager.scene,this.cameraManager.camera)}),window.addEventListener("resize",()=>{this.renderer.updateSize(),this.cameraManager.updateAspect(window.innerWidth/window.innerHeight)}),window.addEventListener("keydown",t=>{t.key==="Escape"&&this.introController.skip()})}centerCamera(){this.cameraManager.setPosition(0,0,20),this.cameraManager.setTarget(0,0,0),this.earth.setPosition(0,0,0),console.log("🎥 Camera position:",this.cameraManager.camera.position),console.log("🎯 Camera target:",this.cameraManager.getTarget()),console.log("🌍 Earth position:",this.earth.group.position),console.log("📐 Canvas size:",this.renderer.size),console.log("📏 Aspect ratio:",this.cameraManager.camera.aspect)}startExperience(){this.introController.play()}onIntroComplete(){this.slider.enable(),this.infoPanel.show()}onPollutionChange(t){this.earth.setPollutionLevel(t),this.smokeSystem.setPollutionLevel(t),this.trashSystem.setPollutionLevel(t),this.infoPanel.update(t)}showError(t){const e=document.querySelector("#app");e&&(e.innerHTML=`
        <div style="
          display: flex;
          align-items: center;
          justify-content: center;
          height: 100vh;
          background: #1a1a1a;
          color: white;
          font-family: system-ui, sans-serif;
          text-align: center;
          padding: 20px;
        ">
          <div>
            <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
            <h1 style="margin: 0 0 10px 0;">Đã xảy ra lỗi</h1>
            <p style="opacity: 0.7;">${t}</p>
            <button onclick="location.reload()" style="
              margin-top: 20px;
              padding: 12px 24px;
              background: #4CAF50;
              color: white;
              border: none;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
            ">Tải lại</button>
          </div>
        </div>
      `)}dispose(){this.animationLoop.stop(),this.earth.dispose(),this.starfield.dispose(),this.smokeSystem.dispose(),this.trashSystem.dispose(),pe(),this.slider.dispose(),this.infoPanel.dispose(),this.introScreen.dispose(),this.introController.dispose(),this.cameraManager.dispose(),this.sceneManager.dispose(),this.renderer.dispose(),console.log("🌍 Application disposed")}}console.log("🌍 Starting STEM Earth Green application...");const dt=new ke;dt.init().catch(o=>{console.error("💥 Failed to initialize app:",o),document.body.innerHTML=`
    <div style="color: white; padding: 20px; background: red;">
      <h1>Error Loading Application</h1>
      <p>${o.message}</p>
      <p>Check console for details</p>
    </div>
  `});window.addEventListener("beforeunload",()=>{dt.dispose()});
